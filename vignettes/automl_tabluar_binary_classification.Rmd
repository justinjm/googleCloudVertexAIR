---
title: "AutoML training tabular binary classification model for batch prediction¶"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{datasets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

Emulation of notebook tutorials using Vertex AI SDK via Python: 

* [vertex-ai-samples/automl-tabular-classification.ipynb at master \| GoogleCloudPlatform/vertex-ai-samples](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/master/notebooks/official/automl/automl-tabular-classification.ipynb)
* [vertex-ai-mlops/02b - Vertex AI - AutoML with clients (code).ipynb at main · statmike/vertex-ai-mlops](https://github.com/statmike/vertex-ai-mlops/blob/main/02b%20-%20Vertex%20AI%20-%20AutoML%20with%20clients%20(code).ipynb)


# Setup

## Installation

Run the following chunk to install `googleCloudVertexAIR` and the other required R packages to complete this tutorial (checking to see if they are installed first and only install if not already): 

```{r install_packages, eval=FALSE}
required_packages <- c("remotes", "googleAuthR")
missing_packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(missing_packages)) install.packages(missing_packages)

# remotes::install_github("justinjm/googleCloudVertexAIR")
options(googleAuthR.verbose = 0) # set for debugging  
``` 

### .Renviron

Create a file called `.Renviron` in your project's working directory and use the following environemtn arguments: 

* `GAR_SERVICE_JSON` - path to service account (JSON) keyfile downloaded before and copied 
* `GCVA_DEFAULT_PROJECT_ID` - string of your GCP project you configured before 
* `GCVA_DEFAULT_REGION` - region of GCP resorces that can be one of: `"us-central1"` or `"eu"` 

e.g. your `.Renviron` should look like: 

```
# .Renviron
GAR_SERVICE_JSON="/Users/me/auth/auth.json"
GCAT_DEFAULT_PROJECT_ID="my-project"
GCAT_DEFAULT_REGION="us-central1"
```

## Setup Google Cloud Project

## Authenticate your Google Cloud Account

```{r auth, warning=FALSE}
library(googleAuthR)
library(googleCloudVertexAIR)

options(googleAuthR.scopes.selected = "https://www.googleapis.com/auth/cloud-platform")

gar_auth_service(json_file = Sys.getenv("GAR_SERVICE_JSON"))
```

## Set global arguements

```{r gcva-global-arguements}
projectId <- Sys.getenv("GCVA_DEFAULT_PROJECT_ID")
gcva_region_set(region = "us-central1")
gcva_project_set(projectId = projectId)

# AutoML dataset
displayName <- paste0("my-experiment-", strftime(Sys.time(), "%Y%m%d%H%M%S"))
displayName
```

## Create a Cloud Storage bucket

# Tutorial

## Create Dataset

```{r}
dataset <- gcva_create_tabluar_dataset(
  displayName = displayName,
  gcsSource = "gs://gcatr-dev/bank_marketing.csv")
dataset
```

## Train Model

### Create training pipeline


Vertex AI Docs:  

* https://cloud.google.com/vertex-ai/docs/training/automl-api#aiplatform_create_training_pipeline_tabular_classification_sample-drest

Python SDK docs:  

* https://cloud.google.com/python/docs/reference/aiplatform/latest/google.cloud.aiplatform.AutoMLTabularTrainingJob
* https://googleapis.dev/python/aiplatform/latest/aiplatform/services.html#google.cloud.aiplatform.AutoMLTabularTrainingJob

REST API docs:   

* https://cloud.google.com/vertex-ai/docs/reference/rest/v1/projects.locations.trainingPipelines

```{zsh}
# copy yaml to local directory for development of functions
# gsutil cp gs://google-cloud-aiplatform/schema/trainingjob/definition/automl_tabular_1.0.0.yaml .
```

dataset: https://datahub.io/machine-learning/bank-marketing

```{r}
job <- gcva_automl_tabluar_training_job(
  displayName = "test1",
  optimizationPredictionType = "classification",
  column_transformations = (categorical = list(columnn_name = "V2")))
job

# job <- gcva_automl_tabluar_training_job(
#   displayName = ,
#   optimizationPredictionType="classification",
#   column_transformations=[
#       {"categorical": {"column_name": "Type"}},
#       {"numeric": {"column_name": "Age"}},
#       {"categorical": {"column_name": "Breed1"}},
#       {"categorical": {"column_name": "Color1"}},
#       {"categorical": {"column_name": "Color2"}},
#       {"categorical": {"column_name": "MaturitySize"}},
#       {"categorical": {"column_name": "FurLength"}},
#       {"categorical": {"column_name": "Vaccinated"}},
#       {"categorical": {"column_name": "Sterilized"}},
#       {"categorical": {"column_name": "Health"}},
#       {"numeric": {"column_name": "Fee"}},
#       {"numeric": {"column_name": "PhotoAmt"}},
#   ],
# )

```


### Run the training pipeline


```{r}
model <- gcva_run_job(
  job = job,
  dataset = displayName,
  targetColumn = "Class",
  modelDisplayName = "test1-classification")
model

# This will take around an hour to run
# model <- gcva_run_job(
#   job = job,
#   dataset=ds,
#     target_column="Adopted",
#     training_fraction_split=0.8,
#     validation_fraction_split=0.1,
#     test_fraction_split=0.1,
#     model_display_name="adopted-prediction-model",
#     disable_early_stopping=False
#   )
# model 
```

## Model deployment for batch prediction

Now deploy the trained Vertex`Model`resource you created for batch prediction. This differs from deploying a`Model`resource for online prediction.

For online prediction, you:

1.  Create an`Endpoint`resource for deploying the`Model`resource to.
2.  Deploy the`Model`resource to the`Endpoint`resource.
3.  Make online prediction requests to the`Endpoint`resource.

For batch-prediction, you:

1.  Create a batch prediction job.
2.  The job service will provision resources for the batch prediction request.
3.  The results of the batch prediction request are returned to the caller.
4.  The job service will unprovision the resoures for the batch prediction request.

## Make a batch prediction request

### Make test items

### Make batch input file

### Make the batch prediction request

### Wait for completion of batch prediction job

### Get predictions

## Cleaning up


## References

* [Vertex AI (aiplatform) AutoML components  |  Google Cloud](https://cloud.google.com/vertex-ai/docs/pipelines/vertex-automl-component) 
  - [vertex-ai-samples/automl_tabular_classification_beans.ipynb at main · GoogleCloudPlatform/vertex-ai-samples](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/pipelines/automl_tabular_classification_beans.ipynb)
- 
